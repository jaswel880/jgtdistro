<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - JGT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <section id="header">
        <a href="index.html"><img src="img/JGT (1).png" class="logo" alt="" srcset=""></a>

        <div>
           <ul id="navbar">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="shop.html">Shop</a></li>
                    <li><a href="blog.html">Blog</a></li>
                    <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li id="lg-bag"><a href="cart.html"><i class="fas fa-cart-shopping"></i></a></li>
                <li id="profile-container">
                    <a class="active" href="login.html" id="login-link"></a>
                </li>
                <a href="#" id="close"><i class="fas fa-times"></i></a>
                </ul>
        </div>
    </section>

    <section id="login" class="section-p1">
        <div class="login-container">
            <img src="img/JGT (1).png" alt="JGT Logo" class="logo">
            <h2>Selamat Datang Kembali</h2>
            <p>Masuk ke akun Anda untuk melanjutkan</p>
            <form action="#" method="post">
                <div class="form-group">
                    <label for="username">Email:</label>
                    <div class="input-container">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="username" name="username" required placeholder="Masukkan email">
                    </div>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <div class="input-container">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" name="password" required placeholder="Masukkan password">
                    </div>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
            <div class="login-links">
                <a href="forgot-password.html">Lupa Password?</a>
                <a href="register.html">Belum punya akun? <span>Daftar</span></a>
            </div>
            <div class="social-login">
                <p>Atau masuk dengan:</p>
                <div class="social-buttons">
                    <button class="social-btn" id="facebook-login"><i class="fab fa-facebook-f"></i> Facebook</button>
                    <button class="social-btn google" id="google-login"><i class="fab fa-google"></i> Google</button>
                </div>
            </div>
        </div>
    </section>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            handleLoginLogout();

            // Check for registration success parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('registered') === 'true') {
                const email = urlParams.get('email');
                if (email) {
                    document.getElementById('username').value = email;
                    toast.show('Akun berhasil dibuat! Silakan login dengan akun baru Anda.', 'success');
                }
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // Add focus effects to inputs
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.parentElement.style.transform = 'translateY(-2px)';
                    this.style.borderColor = '#667eea';
                    this.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
                });
                input.addEventListener('blur', function() {
                    this.parentElement.parentElement.style.transform = 'translateY(0)';
                    this.style.borderColor = '#e1e5e9';
                    this.style.boxShadow = 'none';
                });
            });

            // Toggle password visibility
            const togglePassword = document.getElementById('toggle-password');
            const passwordInput = document.getElementById('password');
            let hideTimeout;

            // Initially hide the toggle if password is empty
            if (passwordInput.value.trim() === '') {
                togglePassword.classList.add('hidden');
            }

            // Show/hide toggle based on input
            passwordInput.addEventListener('input', function() {
                if (this.value.trim() !== '') {
                    togglePassword.classList.remove('hidden');
                    clearTimeout(hideTimeout);
                    hideTimeout = setTimeout(() => {
                        togglePassword.classList.add('hidden');
                    }, 1000);
                } else {
                    togglePassword.classList.add('hidden');
                    clearTimeout(hideTimeout);
                }
            });

            togglePassword.addEventListener('click', function() {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    this.classList.remove('fa-eye');
                    this.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    this.classList.remove('fa-eye-slash');
                    this.classList.add('fa-eye');
                }
            });

            // Add hover effects to buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = this.style.background.includes('linear-gradient') ?
                        '0 6px 20px rgba(102, 126, 234, 0.6)' : '0 6px 20px rgba(0,0,0,0.2)';
                });
                button.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = this.style.background.includes('linear-gradient') ?
                        '0 4px 15px rgba(102, 126, 234, 0.4)' : 'none';
                });
            });

            // Add hover effects to links
            const links = document.querySelectorAll('.login-links a');
            links.forEach(link => {
                link.addEventListener('mouseenter', function() {
                    this.style.color = '#764ba2';
                });
                link.addEventListener('mouseleave', function() {
                    this.style.color = '#667eea';
                });
            });

            // OAuth login handlers
            document.getElementById('facebook-login').addEventListener('click', function() {
                window.location.href = '/auth/facebook';
            });

            document.getElementById('google-login').addEventListener('click', function() {
                window.location.href = '/auth/google';
            });

            // Check for OAuth callback parameters
            const token = urlParams.get('token');
            const userParam = urlParams.get('user');

            if (token && userParam) {
                try {
                    const user = JSON.parse(decodeURIComponent(userParam));
                    localStorage.setItem('token', token);
                    localStorage.setItem('user', JSON.stringify(user));
                    localStorage.setItem('isLoggedIn', 'true');
                    const firstName = user.fullName.split(' ')[0];
                    localStorage.setItem('userName', firstName);

                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);

                    alert('Login berhasil! Selamat datang, ' + firstName + '.');
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Error parsing OAuth callback:', error);
                    alert('Terjadi kesalahan saat login OAuth.');
                }
            }
        });

        document.querySelector('form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username && password) {
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username,
                            password
                        })
                    });

                    let data;
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.indexOf('application/json') !== -1) {
                            data = await response.json();
                        } else {
                            const text = await response.text();
                            if (text.trim() === '') {
                                alert('Unexpected empty response from server.');
                            } else {
                                alert('Unexpected response: ' + text);
                            }
                            return;
                        }
                    } catch (jsonError) {
                        alert('Response is not valid JSON.');
                        return;
                    }

                    if (response.ok) {
                        // Simpan token dan data user di localStorage
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        localStorage.setItem('isLoggedIn', 'true');
                        const firstName = data.user.fullName.split(' ')[0];
                        localStorage.setItem('userName', firstName);

                        alert('Login berhasil! Selamat datang kembali, ' + firstName + '.');
                        window.location.href = 'index.html';
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Network error: ' + error.message);
                }
            } else {
                alert('Username dan password harus diisi.');
            }
        });
    </script>
</body>
</html>

